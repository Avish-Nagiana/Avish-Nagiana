name: Update Profile README

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      repo: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Fetch user data and commit counts
      run: |
        # Initialize commit count
        TOTAL_COMMITS=0

        # Define icon URLs (optional if needed)
        declare -A ICONS_MAP
        ICONS_MAP[Docker]="https://img.shields.io/badge/Docker-%23096AAB.svg?style=flat&logo=docker&logoColor=white"
        ICONS_MAP[JavaScript]="https://img.shields.io/badge/JavaScript-%23323330.svg?style=flat&logo=javascript&logoColor=F7DF1E"
        ICONS_MAP[Python]="https://img.shields.io/badge/Python-%2338A1D1.svg?style=flat&logo=python&logoColor=FFD43B"
        ICONS_MAP[Shell]="https://img.shields.io/badge/Shell-%23121011.svg?style=flat&logo=gnubash&logoColor=4EAA25"
        ICONS_MAP[TypeScript]="https://img.shields.io/badge/TypeScript-%232B7489.svg?style=flat&logo=typescript&logoColor=white"

        # List all repositories (including private ones)
        REPO_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/user/repos?per_page=100&visibility=all | jq -r '.[].name')

        # Iterate over each repository to fetch commit counts
        for REPO in $REPO_LIST; do
          # Fetch commits for each repository
          COMMITS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/Avish-Nagiana/$REPO/commits?per_page=1 | \
            jq -r '.[].sha' | wc -l)

          # Add to total commits
          TOTAL_COMMITS=$((TOTAL_COMMITS + COMMITS))
        done

        # Prepare commit count string
        COMMITS_STRING="Total Commits: $TOTAL_COMMITS"

        # Update README.md with the total commits
        sed -i "/<total_commits>/r /dev/stdin" README.md <<< "$COMMITS_STRING"
        sed -i "/<total_commits>/d" README.md

        # Commit changes
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add README.md
        git commit -m "Update README with total commits"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
